/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * NuevoProducto.java
 *
 * Created on 07-feb-2011, 22:25:52
 */
package es.nutroptima.soft;

import es.nutroptima.soft.model.Categoria;
import es.nutroptima.soft.model.MyVItem;
import es.nutroptima.soft.model.MyVTitulo;
import es.nutroptima.soft.model.Producto;
import es.nutroptima.soft.model.UnidadPeso;
import es.nutroptima.soft.submodels.CategoriasComboBoxModel;
import es.nutroptima.soft.submodels.MyVTitulosComboboxModel;
import es.nutroptima.soft.submodels.UnidadPesoComboBoxModel;
import java.awt.BorderLayout;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.DefaultCellEditor;
import javax.swing.JComboBox;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import nproductregister.NProductRegisterView;

/**
 *
 * @author Sergio Álvarez López <salvarez@nutroptima.es>
 */
public class NuevoProducto extends javax.swing.JPanel {

    private Bienvenida bienvenida;
    private NProductRegisterView view;
    private Producto producto;

    

    public NuevoProducto(NProductRegisterView aThis){
        this.view = aThis;
        initComponents();
        this.listaCategorias.setModel(new CategoriasComboBoxModel());
        this.tablaVyM.setDefaultEditor(UnidadPeso.class, new DefaultCellEditor(new JComboBox(new UnidadPesoComboBoxModel())));

         this.tablaVyM.setDefaultEditor(MyVTitulo.class, new DefaultCellEditor(new JComboBox(new MyVTitulosComboboxModel())));
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        listaCategorias = new javax.swing.JComboBox();
        categoriaLabel = new javax.swing.JLabel();
        nombreLabel = new javax.swing.JLabel();
        nombre = new javax.swing.JTextField();
        cancel = new javax.swing.JButton();
        saveButton = new javax.swing.JButton();
        panelIems = new javax.swing.JPanel();
        myvLabel = new javax.swing.JLabel();
        addButton = new javax.swing.JButton();
        jScrollPane1 = new javax.swing.JScrollPane();
        tablaVyM = new javax.swing.JTable();
        lMensajesEmergentes = new javax.swing.JLabel();
        bNuevo = new javax.swing.JButton();
        jPanel1 = new javax.swing.JPanel();
        proteinas = new javax.swing.JFormattedTextField();
        hidratos = new javax.swing.JFormattedTextField();
        grasas = new javax.swing.JFormattedTextField();
        kCalorias = new javax.swing.JFormattedTextField();
        kcaloriasLabel = new javax.swing.JLabel();
        jLabel1 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();

        setName("Form"); // NOI18N
        setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        listaCategorias.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Item 1", "Item 2", "Item 3", "Item 4" }));
        listaCategorias.setName("listaCategorias"); // NOI18N
        add(listaCategorias, new org.netbeans.lib.awtextra.AbsoluteConstraints(450, 10, 300, -1));

        org.jdesktop.application.ResourceMap resourceMap = org.jdesktop.application.Application.getInstance(nproductregister.NProductRegisterApp.class).getContext().getResourceMap(NuevoProducto.class);
        categoriaLabel.setText(resourceMap.getString("categoriaLabel.text")); // NOI18N
        categoriaLabel.setName("categoriaLabel"); // NOI18N
        add(categoriaLabel, new org.netbeans.lib.awtextra.AbsoluteConstraints(370, 20, -1, -1));

        nombreLabel.setText(resourceMap.getString("nombreLabel.text")); // NOI18N
        nombreLabel.setName("nombreLabel"); // NOI18N
        add(nombreLabel, new org.netbeans.lib.awtextra.AbsoluteConstraints(20, 20, -1, -1));

        nombre.setText(resourceMap.getString("nombre.text")); // NOI18N
        nombre.setName("nombre"); // NOI18N
        add(nombre, new org.netbeans.lib.awtextra.AbsoluteConstraints(80, 10, 270, -1));

        cancel.setText(resourceMap.getString("cancel.text")); // NOI18N
        cancel.setName("cancel"); // NOI18N
        cancel.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cancelActionPerformed(evt);
            }
        });
        add(cancel, new org.netbeans.lib.awtextra.AbsoluteConstraints(20, 490, -1, -1));

        saveButton.setText(resourceMap.getString("saveButton.text")); // NOI18N
        saveButton.setName("saveButton"); // NOI18N
        saveButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                saveButtonActionPerformed(evt);
            }
        });
        add(saveButton, new org.netbeans.lib.awtextra.AbsoluteConstraints(120, 490, -1, -1));

        panelIems.setBorder(javax.swing.BorderFactory.createTitledBorder(resourceMap.getString("panelIems.border.title"))); // NOI18N
        panelIems.setName("panelIems"); // NOI18N

        myvLabel.setText(resourceMap.getString("myvLabel.text")); // NOI18N
        myvLabel.setName("myvLabel"); // NOI18N

        addButton.setText(resourceMap.getString("addButton.text")); // NOI18N
        addButton.setName("addButton"); // NOI18N
        addButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                addButtonActionPerformed(evt);
            }
        });

        jScrollPane1.setName("jScrollPane1"); // NOI18N

        tablaVyM.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null}
            },
            new String [] {
                "Title 1", "Title 2", "Title 3", "Title 4"
            }
        ));
        tablaVyM.setName("tablaVyM"); // NOI18N
        tablaVyM.setSize(new java.awt.Dimension(800, 600));
        tablaVyM.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyTyped(java.awt.event.KeyEvent evt) {
                mvItemsModelKeyTyped(evt);
            }
        });
        jScrollPane1.setViewportView(tablaVyM);

        lMensajesEmergentes.setText(resourceMap.getString("lMensajesEmergentes.text")); // NOI18N
        lMensajesEmergentes.setName("lMensajesEmergentes"); // NOI18N

        org.jdesktop.layout.GroupLayout panelIemsLayout = new org.jdesktop.layout.GroupLayout(panelIems);
        panelIems.setLayout(panelIemsLayout);
        panelIemsLayout.setHorizontalGroup(
            panelIemsLayout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
            .add(org.jdesktop.layout.GroupLayout.TRAILING, panelIemsLayout.createSequentialGroup()
                .addContainerGap()
                .add(panelIemsLayout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING)
                    .add(org.jdesktop.layout.GroupLayout.LEADING, lMensajesEmergentes, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 699, Short.MAX_VALUE)
                    .add(org.jdesktop.layout.GroupLayout.LEADING, panelIemsLayout.createSequentialGroup()
                        .add(myvLabel)
                        .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                        .add(addButton))
                    .add(org.jdesktop.layout.GroupLayout.LEADING, jScrollPane1, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 699, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
                .addContainerGap())
        );
        panelIemsLayout.setVerticalGroup(
            panelIemsLayout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
            .add(panelIemsLayout.createSequentialGroup()
                .add(panelIemsLayout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
                    .add(myvLabel)
                    .add(addButton))
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(lMensajesEmergentes, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 18, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .add(jScrollPane1, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 255, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
        );

        add(panelIems, new org.netbeans.lib.awtextra.AbsoluteConstraints(20, 120, 740, -1));

        bNuevo.setText(resourceMap.getString("bNuevo.text")); // NOI18N
        bNuevo.setName("bNuevo"); // NOI18N
        bNuevo.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                bNuevoActionPerformed(evt);
            }
        });
        add(bNuevo, new org.netbeans.lib.awtextra.AbsoluteConstraints(230, 490, -1, -1));

        jPanel1.setBorder(javax.swing.BorderFactory.createTitledBorder(resourceMap.getString("jPanel1.border.title"))); // NOI18N
        jPanel1.setName("jPanel1"); // NOI18N

        proteinas.setName("proteinas"); // NOI18N

        hidratos.setName("hidratos"); // NOI18N
        hidratos.setValue(new Double(0.0));

        grasas.setName("grasas"); // NOI18N
        grasas.setValue(new Double(0.0));

        kCalorias.setName("kCalorias"); // NOI18N
        kCalorias.setValue(new Double(0.0));

        kcaloriasLabel.setText(resourceMap.getString("kcaloriasLabel.text")); // NOI18N
        kcaloriasLabel.setName("kcaloriasLabel"); // NOI18N

        jLabel1.setText(resourceMap.getString("jLabel1.text")); // NOI18N
        jLabel1.setName("jLabel1"); // NOI18N

        jLabel2.setText(resourceMap.getString("jLabel2.text")); // NOI18N
        jLabel2.setName("jLabel2"); // NOI18N

        jLabel3.setText(resourceMap.getString("jLabel3.text")); // NOI18N
        jLabel3.setName("jLabel3"); // NOI18N

        org.jdesktop.layout.GroupLayout jPanel1Layout = new org.jdesktop.layout.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
            .add(org.jdesktop.layout.GroupLayout.TRAILING, jPanel1Layout.createSequentialGroup()
                .addContainerGap(org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .add(jLabel3)
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(proteinas, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 75, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(jLabel2)
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(hidratos, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 70, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(jLabel1)
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(grasas, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 71, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(kcaloriasLabel)
                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                .add(kCalorias, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 65, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                .add(106, 106, 106))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
            .add(jPanel1Layout.createSequentialGroup()
                .add(jPanel1Layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
                    .add(jLabel3)
                    .add(proteinas, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                    .add(jLabel2)
                    .add(hidratos, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                    .add(jLabel1)
                    .add(grasas, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                    .add(kcaloriasLabel)
                    .add(kCalorias, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        add(jPanel1, new org.netbeans.lib.awtextra.AbsoluteConstraints(20, 40, 740, 70));
    }// </editor-fold>//GEN-END:initComponents

    private void saveButtonActionPerformed(java.awt.event.ActionEvent evt) {
        if (checkFields()) {
            try {
                //si el producto es nuevo lo construimos
                if (this.producto == null) {
                    this.producto = new Producto(this.bienvenida.getUsuarioconectado());
                }
                this.producto.setTitulo(this.nombre.getText());
                this.producto.setProteinas(Double.parseDouble(this.proteinas.getText()));
                this.producto.setGrasas(Double.parseDouble(this.grasas.getText()));
                this.producto.setHidratosCarbono(Double.parseDouble(this.hidratos.getText()));
                this.producto.setKilocalorias(Double.parseDouble(this.kCalorias.getText()));
                this.producto.setCategoria((Categoria) this.listaCategorias.getSelectedItem());
                this.producto.save();
                this.tablaVyM.setModel(producto);
                //visualizar la tabla de las micronutrientes
                this.panelIems.setVisible(true);
            } catch (Exception ex) {
                Logger.getLogger(NuevoProducto.class.getName()).log(Level.SEVERE, null, ex);
                JOptionPane.showMessageDialog(this, "Error al guardar la información.\n Por favor Llame a la central de Nutroptima. Gracias.");
            }
        }

    }

    private void cancelActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cancelActionPerformed
        view.getMainPanel().remove(this);
        view.getMainPanel().add(bienvenida, BorderLayout.NORTH);
        view.getMainPanel().updateUI();
        Logger.getLogger(this.getClass().getName()).info("Cambiando a vista de Bienvenida");
        this.bienvenida.reload();
}//GEN-LAST:event_cancelActionPerformed

    private void mvItemsModelKeyTyped(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_mvItemsModelKeyTyped
        if (evt.getKeyChar() == 's') {
            
                int idx = this.tablaVyM.getSelectedRow();
               
                try {
                    MyVItem item = this.producto.getItems().get(idx);
                    item.save();
                    lMensajesEmergentes.setText("Producto modificado");
                    lMensajesEmergentes.setVisible(true);
                    final JLabel aux = lMensajesEmergentes;
                    Thread t = new Thread(new Runnable() {

                        public void run() {
                            try {
                                System.out.println("Durmiendo");
                                Thread.sleep(1500);
                                lMensajesEmergentes.setText("");
                                System.out.println("Durmiendo");
                                Thread.sleep(100);
                                lMensajesEmergentes.setText("Producto modificado");
                                System.out.println("Durmiendo");
                                Thread.sleep(1500);
                                lMensajesEmergentes.setText("");
                                System.out.println("Durmiendo");
                                Thread.sleep(100);
                                lMensajesEmergentes.setText("Producto modificado");
                                System.out.println("Durmiendo");
                                Thread.sleep(1500);
                                lMensajesEmergentes.setText("");
                                System.out.println("Despieto");
                            } catch (InterruptedException ex) {
                                Logger.getLogger(Bienvenida.class.getName()).log(Level.SEVERE, null, ex);
                            }
                        }
                    });
                    t.start();
                } catch (Exception ex) {
                    Logger.getLogger(NuevoProducto.class.getName()).log(Level.SEVERE, null, ex);
                   
                }

            

        }
    }//GEN-LAST:event_mvItemsModelKeyTyped

    private void addButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_addButtonActionPerformed
        try {
            // TODO add your handling code here:
            MyVItem item = new MyVItem(producto);
            this.producto.getItems().add(item);
            this.tablaVyM.updateUI();
        } catch (Exception ex) {
            Logger.getLogger(NuevoProducto.class.getName()).log(Level.SEVERE, null, "ERROR creando un nuevo item:"+ex);
            showError();
        }
    }//GEN-LAST:event_addButtonActionPerformed

    private void bNuevoActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_bNuevoActionPerformed
        // TODO add your handling code here:
        resetView(null);
    }//GEN-LAST:event_bNuevoActionPerformed

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton addButton;
    private javax.swing.JButton bNuevo;
    private javax.swing.JButton cancel;
    private javax.swing.JLabel categoriaLabel;
    private javax.swing.JFormattedTextField grasas;
    private javax.swing.JFormattedTextField hidratos;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JFormattedTextField kCalorias;
    private javax.swing.JLabel kcaloriasLabel;
    private javax.swing.JLabel lMensajesEmergentes;
    private javax.swing.JComboBox listaCategorias;
    private javax.swing.JLabel myvLabel;
    private javax.swing.JTextField nombre;
    private javax.swing.JLabel nombreLabel;
    private javax.swing.JPanel panelIems;
    private javax.swing.JFormattedTextField proteinas;
    private javax.swing.JButton saveButton;
    private javax.swing.JTable tablaVyM;
    // End of variables declaration//GEN-END:variables

    private boolean checkFields() {
        //Long test = (Long)proteinas.getValue();
        //test+=(Long)hidratos.getValue();
       // infoLabel.setText(proteinas.getValue() + hidratos.getValue().toString());

        return true;

    }

    public void setBienvenida(Bienvenida bienvenida) {
        this.bienvenida = bienvenida;
    }

    public void resetView(Producto p) {
        if (p != null) {
            this.nombre.setText(p.getTitulo());
            this.hidratos.setText("" + p.getHidratosCarbono());
            this.proteinas.setText("" + p.getProteinas());
            this.grasas.setText("" + p.getGrasas());
            this.kCalorias.setText("" + p.getKilocalorias());
            this.tablaVyM.setModel(p);
            this.panelIems.setVisible(true);

            ((CategoriasComboBoxModel) this.listaCategorias.getModel()).setSelectedItem(p.getCategoria());
            tablaVyM.setModel(p);
        } else {
            this.nombre.setText("");
            this.hidratos.setText("0");
            this.proteinas.setText("0");
            this.grasas.setText("0");
            this.kCalorias.setText("0");
            this.panelIems.setVisible(false);
        }
        this.producto = p;

    }



    public void showError(){
         JOptionPane.showMessageDialog(this, "Error salvando el micronutriente. Pongase en contacto con la central de Nutroptima");
    }
}
